// Prisma schema for Ironing Service MVP

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum Role {
  USER
  DELIVERY_PERSON
  FLOOR_MANAGER
  CENTER_OPERATOR
  ADMIN
}

enum TripStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum TripType {
  PICKUP
  DELIVERY
}

enum OrderStatus {
  PLACED
  ASSIGNED_FOR_PICKUP
  PICKED_UP
  AT_CENTER
  PROCESSING
  QC
  READY_FOR_DELIVERY
  ASSIGNED_FOR_DELIVERY
  OUT_FOR_DELIVERY
  DELIVERED
  COMPLETED
  CANCELLED
  PICKUP_FAILED
  DELIVERY_FAILED
  REFUND_REQUESTED
}

enum DeliveryType {
  STANDARD
  PREMIUM
}

enum PayoutStatus {
  PENDING
  COMPLETED
}

// Models
model User {
  id            String    @id @default(uuid())
  name          String
  email         String?   @unique
  phone         String    @unique
  passwordHash  String?
  role          Role      @default(USER)
  referralCode  String?   @unique
  referredBy    String?
  referrer      User?     @relation("Referrals", fields: [referredBy], references: [id], onDelete: SetNull)
  referrals     User[]    @relation("Referrals")
  createdAt     DateTime  @default(now())
  addresses     Address[]
  wallet        Wallet?
  orders        Order[]
  authOtps      AuthOTP[]
  transactions  Transaction[]
}

model Transaction {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  type        String
  amountCents Int
  description String
  createdAt   DateTime @default(now())

  @@index([userId, createdAt])
}

model AuthOTP {
  id         String    @id @default(uuid())
  phone      String
  codeHash   String
  expiresAt  DateTime
  verifiedAt DateTime?
  userId     String?
  user       User?     @relation(fields: [userId], references: [id])
  createdAt  DateTime  @default(now())

  @@index([phone, expiresAt])
}

model Address {
  id      String  @id @default(uuid())
  userId  String
  user    User    @relation(fields: [userId], references: [id])
  label   String
  line1   String
  city    String
  pincode String
  lat     Float?
  lng     Float?
  orders  Order[]
}

model Wallet {
  id           String @id @default(uuid())
  userId       String @unique
  user         User   @relation(fields: [userId], references: [id])
  balanceCents Int    @default(0)
}

model Service {
  id             String      @id @default(uuid())
  name           String
  basePriceCents Int
  orderItems     OrderItem[]
}

model Center {
  id        String     @id @default(uuid())
  name      String
  address   String
  timeslots Timeslot[]
  orders    Order[]
}

model Timeslot {
  id                String   @id @default(uuid())
  centerId          String
  center            Center   @relation(fields: [centerId], references: [id])
  date              DateTime
  startTime         String
  endTime           String
  capacity          Int
  remainingCapacity Int
  orders            Order[]
}

model Trip {
  id                 String     @id @default(uuid())
  deliveryPersonId   String
  type               TripType
  status             TripStatus @default(PENDING)
  scheduledDate      DateTime
  startTime          String
  endTime            String
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt
  pickupOrders       Order[]    @relation("PickupTrip")
  deliveryOrders     Order[]    @relation("DeliveryTrip")
}

model Order {
  id                    String       @id @default(uuid())
  userId                String
  user                  User         @relation(fields: [userId], references: [id])
  addressId             String
  address               Address      @relation(fields: [addressId], references: [id])
  centerId              String?
  center                Center?      @relation(fields: [centerId], references: [id])
  timeslotId            String
  timeslot              Timeslot     @relation(fields: [timeslotId], references: [id])
  pickupTripId          String?
  pickupTrip            Trip?        @relation("PickupTrip", fields: [pickupTripId], references: [id])
  deliveryTripId        String?
  deliveryTrip          Trip?        @relation("DeliveryTrip", fields: [deliveryTripId], references: [id])
  status                OrderStatus  @default(PLACED)
  deliveryType          DeliveryType @default(STANDARD)
  deliveryChargeCents   Int          @default(0)
  estimatedDeliveryTime DateTime?
  totalCents            Int
  paymentMethod         String       @default("WALLET")
  cancellationReason    String?
  pickupFailureReason   String?
  pickupTimeSlot        String?
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt
  items                 OrderItem[]
  logs                  OrderLog[]
  photos                Photo[]
  otps                  OTP[]
  payouts               Payout[]
}

model OrderItem {
  id         String  @id @default(uuid())
  orderId    String
  order      Order   @relation(fields: [orderId], references: [id])
  serviceId  String
  service    Service @relation(fields: [serviceId], references: [id])
  name       String
  quantity   Int
  priceCents Int
}

model OrderLog {
  id         String   @id @default(uuid())
  orderId    String
  order      Order    @relation(fields: [orderId], references: [id])
  fromStatus String?
  toStatus   String
  actorId    String
  actorRole  Role
  metadata   Json?
  createdAt  DateTime @default(now())
}

model Photo {
  id             String   @id @default(uuid())
  orderId        String
  order          Order    @relation(fields: [orderId], references: [id])
  uploadedByRole Role
  type           String
  path           String
  createdAt      DateTime @default(now())
}

model OTP {
  id         String    @id @default(uuid())
  orderId    String
  order      Order     @relation(fields: [orderId], references: [id])
  codeHash   String
  action     String
  expiresAt  DateTime
  verifiedAt DateTime?
  createdAt  DateTime  @default(now())
}

model Payout {
  id                 String       @id @default(uuid())
  deliveryPersonId   String
  orderId            String
  order              Order        @relation(fields: [orderId], references: [id])
  amountCents        Int
  status             PayoutStatus @default(PENDING)
  createdAt          DateTime     @default(now())
}
